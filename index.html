<!DOCTYPE html>
<html lang="en">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>Canadian Finance Tracker (Light Theme)</title>
Â  Â  <script src="https://cdn.tailwindcss.com"></script>
Â  Â  <style>
Â  Â  Â  Â  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
Â  Â  Â  Â  :root {
Â  Â  Â  Â  Â  Â  font-family: 'Inter', sans-serif;
Â  Â  Â  Â  }
Â  Â  Â  Â  /* --- LIGHT THEME DEFINITIONS --- */
Â  Â  Â  Â  .text-neon-green { color: #10B981; } /* Slightly softer green accent for light theme */
Â  Â  Â  Â  .bg-card { background-color: #ffffff; } /* Pure white cards */
Â  Â  Â  Â  .shadow-neon { box-shadow: 0 0 10px rgba(16, 185, 129, 0.2); } /* Softer shadow */

Â  Â  Â  Â  /* --- MATERIAL 3 OUTLINED INPUT STYLE (Adjusted for Light Theme) --- */
Â  Â  Â  Â  .input-field-styled {
Â  Â  Â  Â  Â  Â  /* Increased padding for better tap targets and aesthetics (py-5 is 1.25rem padding top/bottom) */
Â  Â  Â  Â  Â  Â  @apply bg-white border border-gray-300 text-gray-800 placeholder-gray-500 rounded-xl py-5 px-4 w-full transition duration-200 appearance-none;
Â  Â  Â  Â  }
Â  Â  Â  Â  .input-field-styled:focus {
Â  Â  Â  Â  Â  Â  /* Focus remains the accent green */
Â  Â  Â  Â  Â  Â  @apply outline-none border-neon-green ring-2 ring-neon-green shadow-md;
Â  Â  Â  Â  }
Â  Â  Â  Â  /* Ensure options in select boxes are legible on white backgrounds */
Â  Â  Â  Â  .input-field-styled option {
Â  Â  Â  Â  Â  Â  background: #ffffff;Â 
Â  Â  Â  Â  Â  Â  color: #1f2937;
Â  Â  Â  Â  }
Â  Â  Â  Â  /* ---------------------------------- */
Â  Â  Â  Â  .btn-primary {
Â  Â  Â  Â  Â  Â  /* Increased height to match input fields (changed py-2 to py-4) */
Â  Â  Â  Â  Â  Â  @apply bg-green-600 hover:bg-green-700 text-white font-semibold py-4 px-4 rounded-xl transition duration-200 shadow-lg;
Â  Â  Â  Â  }
Â  Â  </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen p-4 md:p-8">
Â  Â Â 
Â  Â  <!-- Global Alert/Message Box Container -->
Â  Â  <div id="globalMessageContainer" class="fixed top-4 right-4 z-50 w-full max-w-sm"></div>

Â  Â  <!-- Main Application Container -->
Â  Â  <div id="app" class="max-w-7xl mx-auto">
Â  Â  Â  Â  <header class="text-center mb-10">
Â  Â  Â  Â  Â  Â  <h1 class="text-4xl font-extrabold text-neon-green mb-2">ðŸ’° North Star Finance Dashboard</h1>
Â  Â  Â  Â  Â  Â  <p class="text-gray-600">Your consolidated, private financial overview.</p>
Â  Â  Â  Â  Â  Â  <div id="loadingIndicator" class="hidden mt-4">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-neon-green mx-auto"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm text-neon-green mt-2">Processing...</p>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </header>

Â  Â  Â  Â  <!-- Tabs/Navigation (Responsive) -->
Â  Â  Â  Â  <div class="flex border-b border-gray-200 mb-8 overflow-x-auto whitespace-nowrap">
Â  Â  Â  Â  Â  Â  <!-- Dashboard Tab (Active by Default) -->
Â  Â  Â  Â  Â  Â  <button onclick="showSection('dashboard')" id="tab-dashboard" class="py-2 px-4 text-sm font-medium border-b-2 border-neon-green focus:outline-none transition duration-150 text-neon-green font-semibold">Dashboard</button>
Â  Â  Â  Â  Â  Â  <!-- Accounts Tab (Inactive by Default) -->
Â  Â  Â  Â  Â  Â  <button onclick="showSection('accounts')" id="tab-accounts" class="py-2 px-4 text-sm font-medium border-b-2 border-transparent hover:border-neon-green focus:outline-none transition duration-150 text-gray-600 hover:text-gray-800">Accounts & People</button>
Â  Â  Â  Â  Â  Â  <button onclick="showSection('upload')" id="tab-upload" class="py-2 px-4 text-sm font-medium border-b-2 border-transparent hover:border-neon-green focus:outline-none transition duration-150 text-gray-600 hover:text-gray-800">Upload Transactions</button>
Â  Â  Â  Â  Â  Â  <button onclick="showSection('history')" id="tab-history" class="py-2 px-4 text-sm font-medium border-b-2 border-transparent hover:border-neon-green focus:outline-none transition duration-150 text-gray-600 hover:text-gray-800">History</button>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <!-- Dashboard Section (Active by Default) -->
Â  Â  Â  Â  <section id="dashboard" class="app-section">
Â  Â  Â  Â  Â  Â  <!-- Responsive Grid: 1 column on mobile, 3 columns on desktop -->
Â  Â  Â  Â  Â  Â  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-card p-6 rounded-xl shadow-lg border border-gray-200">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm text-gray-500">Total Net Worth</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 id="netWorthDisplay" class="text-3xl font-bold mt-1 text-neon-green">$0.00</h2>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-card p-6 rounded-xl shadow-lg border border-gray-200">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm text-gray-500">Total Accounts</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 id="totalAccountsDisplay" class="text-3xl font-bold mt-1 text-gray-800">0</h2>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-card p-6 rounded-xl shadow-lg border border-gray-200">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm text-gray-500">Total Transactions</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 id="totalTransactionsDisplay" class="text-3xl font-bold mt-1 text-gray-800">0</h2>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <h3 class="text-2xl font-semibold mb-4 text-gray-800">Account SummaryÂ </h3>
Â  Â  Â  Â  Â  Â  <div id="dashboardAccountList" class="space-y-4">
Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-gray-500">No accounts added yet.</p>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </section>

Â  Â  Â  Â  <!-- Accounts Section (Hidden by Default) -->
Â  Â  Â  Â  <section id="accounts" class="app-section hidden">
Â  Â  Â  Â  Â  Â  <h3 class="text-2xl font-semibold mb-6 text-gray-800">Manage Accounts & Family</h3>

Â  Â  Â  Â  Â  Â  <!-- Person Management Form -->
Â  Â  Â  Â  Â  Â  <div class="bg-card p-6 rounded-xl shadow-lg mb-8 border border-gray-200">
Â  Â  Â  Â  Â  Â  Â  Â  <h4 class="text-xl font-medium mb-4 text-neon-green">Manage Family Members</h4>
Â  Â  Â  Â  Â  Â  Â  Â  <form id="addPersonForm" class="flex flex-col md:flex-row gap-4 mb-6">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="personName" placeholder="New Member Name (e.g., Jane)" required class="input-field-styled flex-grow">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" class="btn-primary">Add Member</button>
Â  Â  Â  Â  Â  Â  Â  Â  </form>

Â  Â  Â  Â  Â  Â  Â  Â  <div id="personList" class="space-y-2 text-sm">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- Persons listed here -->
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <!-- Add Account Form -->
Â  Â  Â  Â  Â  Â  <div class="bg-card p-6 rounded-xl shadow-lg mb-8 border border-gray-200">
Â  Â  Â  Â  Â  Â  Â  Â  <h4 class="text-xl font-medium mb-4 text-neon-green">Add New Account</h4>
Â  Â  Â  Â  Â  Â  Â  Â  <!-- Responsive Grid: 1 column on mobile, 4 columns on desktop -->
Â  Â  Â  Â  Â  Â  Â  Â  <form id="addAccountForm" class="grid grid-cols-1 md:grid-cols-4 gap-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="accountName" placeholder="Account Nickname (e.g., TD Checking)" required class="input-field-styled col-span-full md:col-span-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="accountCode" placeholder="Code (e.g., TDCH)" required pattern="[A-Za-z0-9]{4}" title="4 characters only, used for CSV matching (e.g., BankCode + TypeCode)" maxlength="4" class="input-field-styled">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="accountType" required class="input-field-styled">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="" disabled selected>Select Type</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Checking">Checking</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Savings">Savings</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Credit">Credit Card</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="RRSP">RRSP (Inv)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="TFSA">TFSA (Inv)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="HFSA">FHSA (Inv)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="RESP">RESP (Inv)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="accountPerson" required class="input-field-styled">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- Options filled by JS -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="accountBalance" placeholder="Initial Balance (CAD)" required step="0.01" class="input-field-styled">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" class="btn-primary md:col-span-1">Add Account</button>
Â  Â  Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <!-- Account List -->
Â  Â  Â  Â  Â  Â  <div class="bg-card p-6 rounded-xl shadow-lg border border-gray-200">
Â  Â  Â  Â  Â  Â  Â  Â  <h4 class="text-xl font-medium mb-4">Your Accounts (<span id="accountCount">0</span>)</h4>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="accountList" class="space-y-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-gray-500">Your accounts will appear here.</p>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </section>

Â  Â  Â  Â  <!-- Upload Section -->
Â  Â  Â  Â  <section id="upload" class="app-section hidden">
Â  Â  Â  Â  Â  Â  <h3 class="text-2xl font-semibold mb-6 text-gray-800">Transaction Data Upload</h3>

Â  Â  Â  Â  Â  Â  <div class="bg-card p-6 rounded-xl shadow-lg border border-gray-200">
Â  Â  Â  Â  Â  Â  Â  Â  <h4 class="text-xl font-medium mb-4 text-neon-green">Import TD-Style CSV File</h4>
Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm text-gray-600 mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  The parser is configured for the **TD Bank 5-column format**: `Date,Description,Expense,Income,Balance`.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <br>The filename **must** follow the convention: **`BANK_PERSON_TYPE_MM_YY.csv`**
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <br>Example: `TD_ME_CH_10_25.csv` (TD Bank, Person ME, Checking Account, Oct 2025)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <br>The file contents are matched against the 4-character **Code** (e.g., TDCH) and the **Person's two-letter code** (e.g., ME) defined in your accounts list.
Â  Â  Â  Â  Â  Â  Â  Â  </p>

Â  Â  Â  Â  Â  Â  Â  Â  <form id="uploadForm">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="csvFile" class="block mb-2 text-sm font-medium text-gray-700">Choose CSV File</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- Input file styling adjusted for light theme -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="file" id="csvFile" accept=".csv" required class="block w-full text-sm text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-gray-200 file:text-neon-green hover:file:bg-gray-300 transition duration-150">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" class="btn-primary mt-6">Process & Upload Transactions</button>
Â  Â  Â  Â  Â  Â  Â  Â  </form>

Â  Â  Â  Â  Â  Â  Â  Â  <div id="uploadMessage" class="mt-4 text-sm"></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </section>

Â  Â  Â  Â  <!-- History Section -->
Â  Â  Â  Â  <section id="history" class="app-section hidden">
Â  Â  Â  Â  Â  Â  <h3 class="text-2xl font-semibold mb-6 text-gray-800">Transaction History</h3>

Â  Â  Â  Â  Â  Â  <!-- Responsive Filtering Layout -->
Â  Â  Â  Â  Â  Â  <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
Â  Â  Â  Â  Â  Â  Â  Â  <select id="historyFilterAccount" class="input-field-styled w-full md:w-1/3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="all">All Accounts</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- Options filled by JS -->
Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="historyFilterSearch" placeholder="Filter by Description" class="input-field-styled w-full md:w-1/3">
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <!-- Table Container with Mobile Horizontal Scrolling -->
Â  Â  Â  Â  Â  Â  <div class="bg-card p-6 rounded-xl shadow-lg border border-gray-200 overflow-x-auto">
Â  Â  Â  Â  Â  Â  Â  Â  <table class="min-w-full divide-y divide-gray-200">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Account</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tbody id="transactionHistoryBody" class="divide-y divide-gray-100">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- Transactions injected here -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  Â  Â  Â  Â  <p id="noTransactionsMessage" class="text-center text-gray-500 py-4 hidden">No transactions recorded yet.</p>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </section>
Â  Â  </div>
Â  Â Â 
Â  Â  <!-- Global Alert/Message Box Component (Custom implementation to avoid alert()) -->
Â  Â  <script>
Â  Â  Â  Â  /** Shows a floating, dismissible message (replaces alert/confirm for non-critical messages). */
Â  Â  Â  Â  const showMessage = (text, type = 'success', duration = 5000) => {
Â  Â  Â  Â  Â  Â  const container = document.getElementById('globalMessageContainer');
Â  Â  Â  Â  Â  Â  const colorMap = {
Â  Â  Â  Â  Â  Â  Â  Â  'success': 'bg-green-600 border-green-400',
Â  Â  Â  Â  Â  Â  Â  Â  'error': 'bg-red-600 border-red-400',
Â  Â  Â  Â  Â  Â  Â  Â  'info': 'bg-blue-600 border-blue-400'
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const message = document.createElement('div');
Â  Â  Â  Â  Â  Â  // Using dark theme colors for the notification box itself to ensure contrast
Â  Â  Â  Â  Â  Â  message.className = `p-4 mb-2 rounded-lg shadow-xl text-white text-sm border-l-4 ${colorMap[type]} transition-opacity duration-300`;
Â  Â  Â  Â  Â  Â  message.textContent = text;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  container.prepend(message); // Prepend so new messages appear at the top

Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  message.classList.add('opacity-0');
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => message.remove(), 300);
Â  Â  Â  Â  Â  Â  }, duration);
Â  Â  Â  Â  };
Â  Â  </script>


Â  Â  <script>
Â  Â  Â  Â  const STORAGE_KEY = 'financeTrackerData';
Â  Â  Â  Â  // Account type mapping for calculating net worth (Liability vs Asset)
Â  Â  Â  Â  const ACCT_TYPES = {
Â  Â  Â  Â  Â  Â  Checking: 'Cash', Savings: 'Cash', Credit: 'Liability',
Â  Â  Â  Â  Â  Â  RRSP: 'Investment', TFSA: 'Investment', HFSA: 'Investment', RESP: 'Investment'
Â  Â  Â  Â  };

Â  Â  Â  Â  let data = {
Â  Â  Â  Â  Â  Â  accounts: [],
Â  Â  Â  Â  Â  Â  persons: ['Me'], // Start with "Me"
Â  Â  Â  Â  Â  Â  transactions: []
Â  Â  Â  Â  };

Â  Â  Â  Â  // --- Utility Functions ---

Â  Â  Â  Â  /** Loads data from localStorage or initializes default structure. */
Â  Â  Â  Â  const loadData = () => {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const stored = localStorage.getItem(STORAGE_KEY);
Â  Â  Â  Â  Â  Â  Â  Â  if (stored) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data = JSON.parse(stored);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Ensure core arrays exist
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!Array.isArray(data.transactions)) { data.transactions = []; }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!Array.isArray(data.persons)) { data.persons = ['Me']; }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!data.persons.includes('Me')) { data.persons.unshift('Me'); }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Ensure accounts have a unique ID and code (migration safety)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data.accounts = data.accounts.map(account => ({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ...account,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id: account.id || generateId(),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Ensure code exists for older entries
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  code: account.code || (account.name.substring(0, 2) + account.type.substring(0, 2)).toUpperCase()
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }));
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Could not load data from localStorage:", e);
Â  Â  Â  Â  Â  Â  Â  Â  data = { accounts: [], persons: ['Me'], transactions: [] };
Â  Â  Â  Â  Â  Â  Â  Â  showMessage("Error loading data. Using default structure.", 'error');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  /** Saves the current data object to localStorage. */
Â  Â  Â  Â  const saveData = () => {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Could not save data to localStorage:", e);
Â  Â  Â  Â  Â  Â  Â  Â  showMessage('Error: Failed to save data. Storage might be full or blocked.', 'error');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  /** Generates a simple unique ID. */
Â  Â  Â  Â  const generateId = () => 'ac' + (Math.random().toString(36).substring(2, 9));

Â  Â  Â  Â  /** Formats number as currency. */
Â  Â  Â  Â  const formatCurrency = (amount) => {
Â  Â  Â  Â  Â  Â  return new Intl.NumberFormat('en-CA', {
Â  Â  Â  Â  Â  Â  Â  Â  style: 'currency',
Â  Â  Â  Â  Â  Â  Â  Â  currency: 'CAD'
Â  Â  Â  Â  Â  Â  }).format(amount);
Â  Â  Â  Â  };

Â  Â  Â  Â  // --- Person & Account Management ---

Â  Â  Â  Â  const renderPeopleAndAccounts = () => {
Â  Â  Â  Â  Â  Â  // Containers
Â  Â  Â  Â  Â  Â  const listContainer = document.getElementById('accountList');
Â  Â  Â  Â  Â  Â  const dashboardContainer = document.getElementById('dashboardAccountList');
Â  Â  Â  Â  Â  Â  const historyFilter = document.getElementById('historyFilterAccount');
Â  Â  Â  Â  Â  Â  const personSelect = document.getElementById('accountPerson');
Â  Â  Â  Â  Â  Â  const accountCountSpan = document.getElementById('accountCount');
Â  Â  Â  Â  Â  Â  const personListContainer = document.getElementById('personList');Â 

Â  Â  Â  Â  Â  Â  // Clear containers
Â  Â  Â  Â  Â  Â  listContainer.innerHTML = '';
Â  Â  Â  Â  Â  Â  dashboardContainer.innerHTML = '';
Â  Â  Â  Â  Â  Â  historyFilter.innerHTML = '<option value="all">All Accounts</option>';
Â  Â  Â  Â  Â  Â  personSelect.innerHTML = '<option value="" disabled selected>Select Owner</option>';

Â  Â  Â  Â  Â  Â  accountCountSpan.textContent = data.accounts.length;
Â  Â  Â  Â  Â  Â  document.getElementById('totalAccountsDisplay').textContent = data.accounts.length;

Â  Â  Â  Â  Â  Â  if (data.accounts.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  listContainer.innerHTML = '<p class="text-gray-500">Your accounts will appear here.</p>';
Â  Â  Â  Â  Â  Â  Â  Â  dashboardContainer.innerHTML = '<p class="text-gray-500">No accounts added yet.</p>';
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // 1. Populate Persons Dropdown and List
Â  Â  Â  Â  Â  Â  personListContainer.innerHTML = '';
Â  Â  Â  Â  Â  Â  data.persons.forEach(person => {
Â  Â  Â  Â  Â  Â  Â  Â  personSelect.innerHTML += `<option value="${person}">${person}</option>`;

Â  Â  Â  Â  Â  Â  Â  Â  const isDeletable = person !== 'Me';
Â  Â  Â  Â  Â  Â  Â  Â  personListContainer.innerHTML += `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-center bg-gray-100 p-3 rounded-lg border border-gray-200">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-gray-800">${person}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${isDeletable ? `<button onclick="deletePerson('${person}')" class="text-red-500 hover:text-red-600 transition duration-150 p-1" title="Remove Member">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>` : `<span class="text-gray-400">Default</span>`}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  // 2. Populate Accounts List
Â  Â  Â  Â  Â  Â  data.accounts.forEach(account => {
Â  Â  Â  Â  Â  Â  Â  Â  const isPositive = ACCT_TYPES[account.type] !== 'Liability';
Â  Â  Â  Â  Â  Â  Â  Â  const balanceDisplay = formatCurrency(account.balance);
Â  Â  Â  Â  Â  Â  Â  Â  // Updated balance colors for light theme
Â  Â  Â  Â  Â  Â  Â  Â  const balanceClass = isPositive ? 'text-green-600' : 'text-red-600';

Â  Â  Â  Â  Â  Â  Â  Â  // Account List (Management)
Â  Â  Â  Â  Â  Â  Â  Â  const listItem = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="account-${account.id}" class="flex flex-col md:flex-row justify-between items-start md:items-center bg-gray-100 p-4 rounded-xl border border-gray-200 hover:bg-gray-200 transition duration-150">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-lg font-semibold text-gray-800">${account.name} <span class="text-sm text-gray-500">(${account.code} - ${account.type} - ${account.person})</span></p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="${balanceClass} text-sm mt-1">Balance: ${balanceDisplay}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="deleteAccount('${account.id}')" class="text-red-500 hover:text-red-600 p-2 rounded-full transition duration-150 mt-2 md:mt-0" title="Delete Account">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  listContainer.innerHTML += listItem;

Â  Â  Â  Â  Â  Â  Â  Â  // Dashboard List
Â  Â  Â  Â  Â  Â  Â  Â  const dashboardItem = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-center bg-gray-100 p-4 rounded-xl border border-gray-200">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="font-medium text-gray-800">${account.name} <span class="text-xs text-gray-500">(${account.code} / ${account.type})</span></p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-xs text-gray-600">Owner: ${account.person}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-lg font-bold ${balanceClass}">${balanceDisplay}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  dashboardContainer.innerHTML += dashboardItem;

Â  Â  Â  Â  Â  Â  Â  Â  // History Filter
Â  Â  Â  Â  Â  Â  Â  Â  historyFilter.innerHTML += `<option value="${account.id}">${account.name} (${account.code})</option>`;
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  // Calculate Net Worth
Â  Â  Â  Â  Â  Â  const netWorth = data.accounts.reduce((sum, account) => {
Â  Â  Â  Â  Â  Â  Â  Â  // Treat Credit accounts with positive balances as liabilities (negative net worth contribution)
Â  Â  Â  Â  Â  Â  Â  Â  const contribution = (account.type === 'Credit' && account.balance > 0) ? -account.balance : account.balance;
Â  Â  Â  Â  Â  Â  Â  Â  return sum + contribution;
Â  Â  Â  Â  Â  Â  }, 0);
Â  Â  Â  Â  Â  Â  document.getElementById('netWorthDisplay').textContent = formatCurrency(netWorth);
Â  Â  Â  Â  };

Â  Â  Â  Â  /** Replaced window.confirm with direct deletion for compliance */
Â  Â  Â  Â  const deletePerson = (name) => {
Â  Â  Â  Â  Â  Â  const accountsOwned = data.accounts.filter(acct => acct.person === name);
Â  Â  Â  Â  Â  Â  if (accountsOwned.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessage(`Cannot delete ${name}. They still own ${accountsOwned.length} account(s). Please reassign or delete their accounts first.`, 'error');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  data.persons = data.persons.filter(p => p !== name);
Â  Â  Â  Â  Â  Â  saveData();
Â  Â  Â  Â  Â  Â  renderPeopleAndAccounts();
Â  Â  Â  Â  Â  Â  showMessage(`${name} has been removed.`, 'info');
Â  Â  Â  Â  };

Â  Â  Â  Â  /** Replaced window.confirm with direct deletion for compliance */
Â  Â  Â  Â  const deleteAccount = (id) => {
Â  Â  Â  Â  Â  Â  data.accounts = data.accounts.filter(acct => acct.id !== id);
Â  Â  Â  Â  Â  Â  data.transactions = data.transactions.filter(t => t.accountId !== id); // Remove associated transactions
Â  Â  Â  Â  Â  Â  saveData();
Â  Â  Â  Â  Â  Â  renderAll();
Â  Â  Â  Â  Â  Â  showMessage("Account and associated transactions deleted.", 'info');
Â  Â  Â  Â  };

Â  Â  Â  Â  document.getElementById('addPersonForm').addEventListener('submit', (e) => {
Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  const name = document.getElementById('personName').value.trim();
Â  Â  Â  Â  Â  Â  if (name) {
Â  Â  Â  Â  Â  Â  Â  Â  addPerson(name);
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('personName').value = '';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  document.getElementById('addAccountForm').addEventListener('submit', (e) => {
Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  const name = document.getElementById('accountName').value.trim();
Â  Â  Â  Â  Â  Â  const code = document.getElementById('accountCode').value.trim().toUpperCase();Â 
Â  Â  Â  Â  Â  Â  const type = document.getElementById('accountType').value;
Â  Â  Â  Â  Â  Â  const person = document.getElementById('accountPerson').value;
Â  Â  Â  Â  Â  Â  const balance = parseFloat(document.getElementById('accountBalance').value);

Â  Â  Â  Â  Â  Â  if (data.accounts.some(acct => acct.code === code)) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessage(`Account code "${code}" is already in use. Please choose a unique 4-character code.`, 'error');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const newAccount = {
Â  Â  Â  Â  Â  Â  Â  Â  id: generateId(),
Â  Â  Â  Â  Â  Â  Â  Â  code: code,Â 
Â  Â  Â  Â  Â  Â  Â  Â  name: name,
Â  Â  Â  Â  Â  Â  Â  Â  type: type,
Â  Â  Â  Â  Â  Â  Â  Â  person: person,
Â  Â  Â  Â  Â  Â  Â  Â  balance: balance,
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  data.accounts.push(newAccount);
Â  Â  Â  Â  Â  Â  saveData();
Â  Â  Â  Â  Â  Â  renderPeopleAndAccounts();
Â  Â  Â  Â  Â  Â  document.getElementById('addAccountForm').reset();
Â  Â  Â  Â  Â  Â  showMessage(`Account "${name} (${code})" added.`, 'success');
Â  Â  Â  Â  });

Â  Â  Â  Â  /** Updates account balance based on a new transaction. */
Â  Â  Â  Â  const updateAccountBalance = (accountId, amount) => {
Â  Â  Â  Â  Â  Â  const account = data.accounts.find(acct => acct.id === accountId);
Â  Â  Â  Â  Â  Â  if (account) {
Â  Â  Â  Â  Â  Â  Â  Â  account.balance = parseFloat((account.balance + amount).toFixed(2));
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  /** Parses a transaction CSV file and processes the entries using TD 5-column format. */
Â  Â  Â  Â  const parseCSV = (file) => {
Â  Â  Â  Â  Â  Â  return new Promise((resolve, reject) => {
Â  Â  Â  Â  Â  Â  Â  Â  const reader = new FileReader();

Â  Â  Â  Â  Â  Â  Â  Â  // Naming convention: BANK_PERSON_TYPE_MM_YY.csv
Â  Â  Â  Â  Â  Â  Â  Â  // Groups: [Full Match, BankCode, PersonCode, TypeCode, Month, Year]
Â  Â  Â  Â  Â  Â  Â  Â  const filenameRegex = /^([a-z0-9]{2})_([a-z0-9]{2})_([a-z0-9]{2})_(\d{2})_(\d{2})\.csv$/i;
Â  Â  Â  Â  Â  Â  Â  Â  const filenameMatch = file.name.match(filenameRegex);

Â  Â  Â  Â  Â  Â  Â  Â  if (!filenameMatch) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Filename Mismatch Debug:", {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fileName: file.name,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  expectedRegex: filenameRegex.toString(),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  expectedFormat: 'BANK_PERSON_TYPE_MM_YY.csv (e.g., TD_ME_CH_10_25.csv)'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return reject(`Filename must match the strict format: BANK_PERSON_TYPE_MM_YY.csv. Received: ${file.name}`);
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  const [, bankCode, personCode, typeCode] = filenameMatch;
Â  Â  Â  Â  Â  Â  Â  Â  const combinedAccountCode = (bankCode + typeCode).toUpperCase(); // e.g., TDCH

Â  Â  Â  Â  Â  Â  Â  Â  // 1. Find the target account using the combined code
Â  Â  Â  Â  Â  Â  Â  Â  let targetAccount = data.accounts.find(acct => acct.code === combinedAccountCode);

Â  Â  Â  Â  Â  Â  Â  Â  if (!targetAccount) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Account Code Mismatch Debug:", {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fileName: file.name,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  combinedCodeFound: combinedAccountCode,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  availableCodes: data.accounts.map(a => a.code)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return reject(`No account found matching code: "${combinedAccountCode}". Please check the 4-character Code in your account list.`);
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  // 2. Validate person code (using first two letters of stored person name)
Â  Â  Â  Â  Â  Â  Â  Â  const expectedPersonCode = targetAccount.person.substring(0, 2).toUpperCase();
Â  Â  Â  Â  Â  Â  Â  Â  if (expectedPersonCode !== personCode.toUpperCase()) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Person Code Mismatch Debug:", {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fileName: file.name,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  accountName: targetAccount.name,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  personFoundInFileName: personCode,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  expectedPersonCode: expectedPersonCode
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return reject(`Account "${targetAccount.name}" belongs to ${targetAccount.person}. Expected person code in filename: ${expectedPersonCode}, found: ${personCode}.`);
Â  Â  Â  Â  Â  Â  Â  Â  }


Â  Â  Â  Â  Â  Â  Â  Â  reader.onload = (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const csv = e.target.result;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Simple CSV parsing assuming TD's quote behavior and comma separation
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const lines = csv.split('\n').filter(line => line.trim() !== '');

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (lines.length <= 1) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return reject("CSV file is empty or only contains headers.");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Skipping header line
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const newTransactions = [];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let processedCount = 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let balanceUpdate = 0;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  for (let i = 1; i < lines.length; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const line = lines[i];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const values = line.replace(/"/g, '').split(',');

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Expecting 5 columns: Date, Description, Expense, Income, Balance
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (values.length < 5) continue;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const date = values[0].trim();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const description = values[1].trim();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const expenseStr = values[2].trim();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const incomeStr = values[3].trim();

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let amount = 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let type = '';

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (expenseStr) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  amount = -parseFloat(expenseStr); // Expense is negative (DEBIT)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  type = 'DEBIT';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (incomeStr) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  amount = parseFloat(incomeStr); // Income is positive (CREDIT)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  type = 'CREDIT';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (isNaN(amount) || amount === 0) continue;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Create transaction object
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const transaction = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id: generateId() + (i-1),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  accountId: targetAccount.id,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  date: new Date(date).toISOString().split('T')[0], // YYYY-MM-DD
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  description: description,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  amount: amount,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  accountName: targetAccount.name,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  person: targetAccount.person,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  type: type,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sourceFile: file.name
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Check for duplicates before adding
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const isDuplicate = data.transactions.some(t =>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  t.accountId === transaction.accountId &&
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  t.date === transaction.date &&
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  t.description === transaction.description &&
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  t.amount === transaction.amount
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  );

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!isDuplicate) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  newTransactions.push(transaction);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  balanceUpdate += amount;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  processedCount++;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resolve({ newTransactions, targetAccount, balanceUpdate, processedCount });
Â  Â  Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  Â  Â  reader.onerror = () => reject('Error reading file.');
Â  Â  Â  Â  Â  Â  Â  Â  reader.readAsText(file);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  };

Â  Â  Â  Â  /** Handles the submission of the file upload form. */
Â  Â  Â  Â  document.getElementById('uploadForm').addEventListener('submit', async (e) => {
Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  const fileInput = document.getElementById('csvFile');
Â  Â  Â  Â  Â  Â  const file = fileInput.files[0];
Â  Â  Â  Â  Â  Â  const uploadMessage = document.getElementById('uploadMessage');
Â  Â  Â  Â  Â  Â  const loadingIndicator = document.getElementById('loadingIndicator');

Â  Â  Â  Â  Â  Â  if (!file) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessage('Please select a CSV file to upload.', 'error');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  uploadMessage.textContent = '';
Â  Â  Â  Â  Â  Â  loadingIndicator.classList.remove('hidden');

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const { newTransactions, targetAccount, balanceUpdate, processedCount } = await parseCSV(file);

Â  Â  Â  Â  Â  Â  Â  Â  if (newTransactions.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessage('No new or unique transactions found in file.', 'info');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  uploadMessage.textContent = `File processed, but 0 new transactions added (likely duplicates).`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  // 1. Add new transactions
Â  Â  Â  Â  Â  Â  Â  Â  data.transactions.push(...newTransactions);

Â  Â  Â  Â  Â  Â  Â  Â  // 2. Update account balance (using the current balance in the data array)
Â  Â  Â  Â  Â  Â  Â  Â  updateAccountBalance(targetAccount.id, balanceUpdate);

Â  Â  Â  Â  Â  Â  Â  Â  // 3. Save and re-render everything
Â  Â  Â  Â  Â  Â  Â  Â  saveData();
Â  Â  Â  Â  Â  Â  Â  Â  renderAll();
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  showMessage(`Successfully imported ${processedCount} new transactions for ${targetAccount.name}.`, 'success');
Â  Â  Â  Â  Â  Â  Â  Â  uploadMessage.textContent = `Successfully added ${processedCount} transactions for ${targetAccount.name}. Balance updated by ${formatCurrency(balanceUpdate)}.`;
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  // Switch to history tab to view new transactions
Â  Â  Â  Â  Â  Â  Â  Â  showSection('history');

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Upload Error:', error);
Â  Â  Â  Â  Â  Â  Â  Â  showMessage(error.toString(), 'error', 10000);
Â  Â  Â  Â  Â  Â  Â  Â  uploadMessage.textContent = `Upload failed: ${error.toString()}`;
Â  Â  Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  Â  Â  loadingIndicator.classList.add('hidden');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });


Â  Â  Â  Â  /** Renders the list of transactions in the History tab, applying filters. */
Â  Â  Â  Â  const renderTransactionHistory = () => {
Â  Â  Â  Â  Â  Â  const tbody = document.getElementById('transactionHistoryBody');
Â  Â  Â  Â  Â  Â  const filterAccount = document.getElementById('historyFilterAccount').value;
Â  Â  Â  Â  Â  Â  const filterSearch = document.getElementById('historyFilterSearch').value.toLowerCase();
Â  Â  Â  Â  Â  Â  const noTransactionsMessage = document.getElementById('noTransactionsMessage');

Â  Â  Â  Â  Â  Â  // 1. Filter Transactions
Â  Â  Â  Â  Â  Â  let filteredTransactions = data.transactions;

Â  Â  Â  Â  Â  Â  if (filterAccount !== 'all') {
Â  Â  Â  Â  Â  Â  Â  Â  filteredTransactions = filteredTransactions.filter(t => t.accountId === filterAccount);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (filterSearch) {
Â  Â  Â  Â  Â  Â  Â  Â  filteredTransactions = filteredTransactions.filter(t => t.description.toLowerCase().includes(filterSearch));
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // 2. Sort by date (most recent first)
Â  Â  Â  Â  Â  Â  filteredTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));

Â  Â  Â  Â  Â  Â  // 3. Render
Â  Â  Â  Â  Â  Â  tbody.innerHTML = '';
Â  Â  Â  Â  Â  Â  document.getElementById('totalTransactionsDisplay').textContent = data.transactions.length;

Â  Â  Â  Â  Â  Â  if (filteredTransactions.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  noTransactionsMessage.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  noTransactionsMessage.classList.add('hidden');
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  filteredTransactions.forEach(t => {
Â  Â  Â  Â  Â  Â  Â  Â  const amountClass = t.amount < 0 ? 'text-red-600 font-semibold' : 'text-green-600 font-semibold';
Â  Â  Â  Â  Â  Â  Â  Â  const accountCode = data.accounts.find(a => a.id === t.accountId)?.code || 'N/A';
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  const row = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr class="hover:bg-gray-50 text-sm">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="px-6 py-3 whitespace-nowrap text-gray-500">${t.date}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="px-6 py-3 whitespace-normal text-gray-800">${t.description}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="px-6 py-3 whitespace-nowrap text-gray-500">${accountCode} (${t.person})</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="px-6 py-3 whitespace-nowrap text-right ${amountClass}">${formatCurrency(t.amount)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  tbody.innerHTML += row;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  };

Â  Â  Â  Â  // Add event listeners for history filtering
Â  Â  Â  Â  document.getElementById('historyFilterAccount').addEventListener('change', renderTransactionHistory);
Â  Â  Â  Â  document.getElementById('historyFilterSearch').addEventListener('input', renderTransactionHistory);


Â  Â  Â  Â  /** Full render function to refresh all dynamic parts of the UI. */
Â  Â  Â  Â  const renderAll = () => {
Â  Â  Â  Â  Â  Â  renderPeopleAndAccounts();
Â  Â  Â  Â  Â  Â  renderTransactionHistory();
Â  Â  Â  Â  };


Â  Â  Â  Â  // --- Tab Switching Logic ---

Â  Â  Â  Â  /** Switches the active section and updates tab styling. */
Â  Â  Â  Â  const showSection = (sectionId) => {
Â  Â  Â  Â  Â  Â  // Hide all sections
Â  Â  Â  Â  Â  Â  document.querySelectorAll('.app-section').forEach(section => {
Â  Â  Â  Â  Â  Â  Â  Â  section.classList.add('hidden');
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  // Deactivate all tabs
Â  Â  Â  Â  Â  Â  document.querySelectorAll('[id^="tab-"]').forEach(tab => {
Â  Â  Â  Â  Â  Â  Â  Â  tab.classList.remove('border-neon-green', 'text-neon-green', 'font-semibold');
Â  Â  Â  Â  Â  Â  Â  Â  tab.classList.add('border-transparent', 'text-gray-600', 'hover:border-neon-green', 'hover:text-gray-800');
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  // Show target section
Â  Â  Â  Â  Â  Â  document.getElementById(sectionId).classList.remove('hidden');

Â  Â  Â  Â  Â  Â  // Activate target tab
Â  Â  Â  Â  Â  Â  const activeTab = document.getElementById(`tab-${sectionId}`);
Â  Â  Â  Â  Â  Â  if (activeTab) {
Â  Â  Â  Â  Â  Â  Â  Â  activeTab.classList.remove('border-transparent', 'text-gray-600', 'hover:border-neon-green', 'hover:text-gray-800');
Â  Â  Â  Â  Â  Â  Â  Â  activeTab.classList.add('border-neon-green', 'text-neon-green', 'font-semibold');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };


Â  Â  Â  Â  // --- Initialization ---

Â  Â  Â  Â  window.onload = () => {
Â  Â  Â  Â  Â  Â  loadData();
Â  Â  Â  Â  Â  Â  renderAll();
Â  Â  Â  Â  Â  Â  // Ensure the correct tab is visible on load
Â  Â  Â  Â  Â  Â  showSection('dashboard');
Â  Â  Â  Â  };
Â  Â  </script>


</body>
</html>
